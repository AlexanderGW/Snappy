<?php

/**
 * Snappy, a PHP framework for PHP 5.3+
 *
 * @author Alexander Gailey-White <alex@gailey-white.com>
 *
 * This file is part of Snappy.
 *
 * Snappy is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Snappy is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Snappy.  If not, see <http://www.gnu.org/licenses/>.
 */

class Example_Plugin {
	private static $path;

	public static function init() {
		self::$path = SNAPPY_PLUGIN_PATH . 'example' . DS;

		/**
		 * Route rules can be automatically loaded at runtime after being stored with Route::save()
		 */
		Route::add( 'example.index', '', null, array( 'Example_Plugin', 'initContent' ) );
		Route::add(

			// Route name
			'example.page',

			// Route path relative to Snappy framework, with regex pattern placeholder [page]
			'[page]',
			array(

				// Pattern for [page]. Route data is accessed using Route::getData('page');
				'page' => '[a-z]+',

				// Additional route meta[data] set if route matched.
				'foo' => 'bar'
			),

			// Route callback if matched
			array( 'Example_Plugin', 'initContent' )
		);
	}

	public static function initContent() {

		// Get requested page, routing rule created in 'init'
		$page = Route::getData( 'page' );
		if( empty( $page ) ) {
			$page = 'index';
			Document::addInfoMessage(__('Your framework dataironment has no configuration. This content has been generated by the example plugin.'));
		} elseif( $page == 'index' )
			Http::location();

		// Capture the controller
		$content = Snappy::capture( 'plugin.example.page.' . $page );
		if( is_string( $content ) ) {
			Document::appendBody( $content );
		}
	}

	public static function beforeDocumentGetHead() {

		// Set some document properties
		Document::addStyle( 'plugin/example/asset/style/main.css' );
		Document::addScript( 'plugin/example/asset/js/main.js' );
		Document::setVpWidth( 0 );
		Document::addStyle( 'https://fonts.googleapis.com/css?family=Raleway:400,700' );
		Document::setTitleSeparator( ' &bull; ' );
		Document::setTitle( 'Snappy, a PHP 5.3+ framework for developers and small web apps.' );
		Document::setDescription( 'PHP 5.3+ framework for creating custom web apps with some essential Helpers for security and more.' );
	}

	public static function beforeDocumentGetBody() {
		Document::prependBody( '<header><main><div><a href="' . SNAPPY_URL . '" class="logo">AGW</a></div></main></header><main>' );
		Document::appendBody( '</main>' );
	}
}

Event::add( 'init', array( 'Example_Plugin', 'init' ) );

// Document header
Event::add( 'beforeDocumentGetHead', array( 'Example_Plugin', 'beforeDocumentGetHead' ) );

// Document footer
Event::add( 'beforeDocumentGetBody', array( 'Example_Plugin', 'beforeDocumentGetBody' ) );

// Example event for files in the request, they have been processed in Http::init() and are ready to handle
Event::add( 'httpRequestHasFiles', function ( $files ) {
	var_dump( $files ); exit;
} );